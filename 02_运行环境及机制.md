---
title: 运行环境及机制
author: Allwayso
date: 2025-12-20
status: Completed
---

---

## 寄存器

一种快速保存、内存很小的容器

1. 程序计数器PC：指向下一个执行的指令
2. 指令寄存器IR：保存当前执行的指令
3. 通用寄存器：寄存变量、状态等
4. 程序状态字PSW：保存运算状态（是否进位、符号正负等）和CPU状态（特权级）
5. 栈指针SP：记录恢复数据的起点
6. 代码段寄存器CS：确定代码段在内存中的起始位置
7. 页表基址寄存器CR3：存储进程中虚拟地址和物理地址的映射关系

PC、CS指令寻址组合：CS确定查找起点（基地址），PC负责找到具体指令位置（偏移量）

除此之外寄存器中还有很多类似的寻址组合，对于堆栈寻址、数据寻址、字符串寻址都是类似的逻辑：基地址+偏移量

---

## 保护现场（先进后出）

1. 压入PC和PSW：遇到中断指令立即将指令状态入栈
2. 压入通用寄存器：存入所有的数值等
3. 压入SP：记录进程恢复时的起点

从而保证先恢复数据，一旦PC和PSW恢复就从上一次进程结束的位置重新开始

注意：以上入栈操作只是保存寄存器的值，而非清空寄存器；例如PC的值虽然入栈，但是中断程序继续运行仍需程序计数器操作，所以在保存PC的值之后，PC、CS立即重定向到中断服务程序（ISR）处，开始执行中断服务程序

---

## 中断和异常

广义上的中断包括异常，狭义上中断可以分为异常和外中断

### 异常：

执行当前指令的结果，同步事件

1. 故障：内存访问故障（缺页故障），数据异常（除0）
2. 陷阱：自愿陷入的中断，断点和系统调用

### 中断：

外部硬件导致，异步事件

1. I/O中断：输入输出进程打断当前进程
2. 时钟信号：分时系统中将时间分为一个个时间片，一个进程运行完一个时间片就必须中断
3. 其他硬件中断：如硬件损坏，驱动异常，电脑低电保护等

---

## API

三个特性：

1. 信息隐藏：对于具体实现的数据库结构、代码结构进行隐藏
2. 服务规范：只要遵循服务规范，在不同系统上都可以运行
3. 抽象集成：将具体代码抽象成模块，只需要对模块进行拼接即可

---

## 系统调用

一种API，同时也是一种陷阱

流程:

1. 用户准备阶段：准备参数（存入系统调用号和参数）→调用库函数→触发陷阱（SYSCALL)
2. 模式切换和现场保护：切换到内核态→保护现场→跳转到统一入口
3. 内核服务执行：查找系统调用表对应的系统调用号→执行运行程序
4. 返回用户程序：将运行结果存入寄存器→恢复现场→切换回用户态（SYSRET）

注意：对重要寄存器的操作只能在内核态下执行，也就是保存、恢复现场和特权级切换有先后顺序
